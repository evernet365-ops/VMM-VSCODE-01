# 分段提示詞（開發/部署/測試/回滾）

> 使用方式：依任務階段複製相應段落，填入括號變數即可。所有工作須遵守 `AGENTS.md` 硬規則與 Feature Flag 預設 OFF 原則。

## 1. Context / Plan
- 目標：(填入任務目標)
- 範圍：(服務/模組/檔案)
- 風險：(列高/中/低與原因)
- Feature Flag：(列需用的旗標，預設 OFF)

## 2. 讀檔提示
- 先讀：README、AGENTS、deploy/README、.env.example、package.json、openapi/vmm.yaml、相關服務 src/*
- 紀錄：現況摘要（與任務相關即可）

## 3. 小步計畫範本
1) (小改動) （驗證指令：...）
2) (小改動) （驗證指令：...）
3) (小改動) （驗證指令：...）

## 4. 變更與驗證
- 變更說明：列出檔案與改動重點（避免長篇敘述）
- 驗證指令（至少）：
  - `corepack pnpm run lint`
  - `corepack pnpm run test`
  - 若改 API/契約：`corepack pnpm run openapi:check`、`corepack pnpm run contract:test`
  - 若改 deploy/env：`corepack pnpm run deploy:env:check`
  - 若涉及探測/NTP/健康：`corepack pnpm run smoke:connector`、`corepack pnpm run smoke:scheduler:ntp`

## 5. 回滾與旗標
- 回滾：描述 `git revert <commit>` 或移除 overlay / env_file。
- 旗標驗證：列出需關閉的旗標、OFF 時預期行為（不得重工作/500）。

## 6. 觀測性提示
- 指標：vmm_provider_probe_total、vmm_camera_*、vmm_playback_*、vmm_ntp_*。
- 日誌：需帶 `tenant_id`/`trace_id`（若可得）；失敗採 warn 不 crash。
- 告警建議：NTP failure 連續 N 次、offset 超閾值；playback 慢查詢與 fallback 次數。

## 7. 部署/Smoke 段落
- 部署前：
  - `corepack pnpm run deploy:env:check`
  - `docker compose config`
  - 服務測試 `corepack pnpm --filter @evernet/<svc> run test`
- 煙測：
  - `corepack pnpm run stack:smoke`
  - `corepack pnpm run smoke:connector`
  - `corepack pnpm run smoke:scheduler:ntp`

## 8. 交付回報模板
- 變更概述：
- 影響範圍：
- 驗證結果：
- 回滾方式：
- 旗標狀態：
- 後續建議：
