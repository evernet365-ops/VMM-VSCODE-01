# EverNet VMM/VMS 二次開發藍圖設計功能說明

- 日期: 2026-02-17
- 角色: EverNet 平台（VMS/VMM/SOC-Hub）資深商用工程師與架構師
- 依循規範: `AGENTS.md` 硬規則（先讀再改、小步可回滾、Feature Flag 預設 OFF、不死機、觀測性、測試）

## 1. 開發目標與邊界
- 確保新功能均落在既有服務邊界：VMS 連接器、報表/回放、NTP 時間同步、健康監測。
- 不改動核心框架/目錄/CI 主流程，除非需求明確。
- 所有新能力需 behind Feature Flag，預設 OFF，OFF 時不得進行重工作/拋 500。

## 2. 架構與模組
- 服務清單與埠口：見 `README.md`（connector-vss 3013, scheduler 3015, 等）。
- 部署覆蓋檔：`deploy/env/connector-vss.prod.env`, `deploy/env/scheduler.prod.env`，compose 載入順序為 `.env.example` → deploy overlay。
- API 契約：`openapi/vmm.yaml` 已含 time-sync、報表、回放、AI 事件等。

## 3. Feature Flag 策略（預設 OFF）
- VMS 健康/輪詢/廠牌：`FEATURE_VMS_HEALTH_MONITOR`, `FEATURE_VMS_POLLING_SHARDING`, `FEATURE_VMS_*_CGI/PROBE`, `FEATURE_VMS_SAMPO_CGI`
- 回放/報表：`FEATURE_VMM_PLAYBACK_FALLBACK_SCAN`, `FEATURE_VMM_MANAGEMENT_REPORTS`
- NTP：`FEATURE_VMM_NTP_TIME_SYNC`
- 原則：開啟前需補 env/覆蓋檔，驗證 smoke；關閉即不做重工作且不得 500。

## 4. 開發流程（遵循 AGENTS 模板）
1. STEP 0-2：列 Context/Read/Plan，小步拆解，先讀後改。
2. STEP 3：一次只完成計畫中的第一小步，保持可回滾。
3. STEP 4：最少跑 lint + test；若改 API/契約，跑 openapi:check、contract:test；若改部署，跑 deploy:env:check；若影響健康/觀測性，跑 smoke。
4. STEP 5：提供 rollback 方法與旗標關閉驗證。
5. STEP 6：補 metrics/log/alert（含 tenant_id/trace_id 若適用）。

## 5. 測試矩陣
- 單元/契約：`corepack pnpm run test`, `corepack pnpm run contract:test`
- 型別/靜態：`corepack pnpm run typecheck`, `corepack pnpm run lint`
- 開發/部署檢查：`corepack pnpm run env:check`, `corepack pnpm run deploy:env:check`
- OpenAPI 入口規則：`corepack pnpm run openapi:check`
- MCP/治理：`corepack pnpm run mcp:update`, `corepack pnpm run governance:check`
- Smoke：`corepack pnpm run smoke`, `smoke:connector`, `smoke:scheduler:ntp`

## 6. 觀測性與失效設計
- 指標：camera fps/drop_frames/last_frame_ts、provider_probe_total、playback fallback、NTP sync/server/offset。
- 日誌：使用 shared logger，附 `tenant_id`/`trace_id`（若可得）；NTP/探測/回放失敗需記錄但不 crash。
- Fail-soft：所有外部依賴（IPC/NVR/NTP/索引）逾時或離線時返回降級結果，不得 throw 導致 500。

## 7. 部署與回滾重點
- 部署前：`deploy:env:check` → `docker compose config` → 對應服務測試/煙測。
- 回滾：優先關閉 Feature Flag；必要時移除 overlay 或還原 compose env_file。
- NTP 回滾：`FEATURE_VMM_NTP_TIME_SYNC=false`，`NTP_SERVER_ENABLED=false` 後重啟 scheduler。

## 8. 未來二次開發藍圖（方向）
- 健康狀態擴充：加入 jitter/抖動與長期穩定性指標；黑畫面自動截圖樣本上報（需新旗標）。
- 回放 fallback 強化：可配置掃描窗口與分页策略、慢查詢告警閾值自動化。
- 多站點分片：connector/scheduler 支援 site-aware sharding 與彈性比例。
- 提示與自動化：MCP 產物自動生成 + 提示模板（見《分段提示詞.md》）。
