# EverNet VMM/VMS 安裝報告書

- 文件日期: 2026-02-17
- 專案路徑: `c:\Users\steve\vscode-codex5.3-CCTV-Monitor-v01-20260217`
- 版本分支: `main`

## 1. 安裝目標

- 建立可運行的 EverNet VMM/VMS 多服務環境。
- 完成資料庫初始化、服務啟動、健康檢查與 smoke 驗證。
- 套用部署覆蓋設定（connector/scheduler）以支援廠牌探測與 NTP 控制。

## 2. 環境需求

- 作業系統: Windows（PowerShell）
- Node.js: 24.x
- pnpm: 10.4.1（由 Corepack 管理）
- Docker / Docker Compose

## 3. 安裝與啟動流程

1. 安裝相依與初始化
   - `corepack pnpm run doctor`
   - `node scripts/bootstrap.mjs`
2. 啟動整體服務
   - `corepack pnpm run stack:up`
   - `corepack pnpm run stack:wait`
3. 檢查狀態與基本煙霧測試
   - `corepack pnpm run stack:status`
   - `corepack pnpm run smoke`

## 4. 部署覆蓋設定

- Connector 覆蓋檔: `deploy/env/connector-vss.prod.env`
- Scheduler 覆蓋檔: `deploy/env/scheduler.prod.env`
- Compose 載入順序（後者覆蓋前者）:
  - `.env.example`
  - `deploy/env/*.prod.env`

部署前檢查:
- `corepack pnpm run deploy:env:check`
- `docker compose config`

## 5. 驗證結果項目

- 程式品質:
  - `corepack pnpm run lint`
  - `corepack pnpm run test`
  - `corepack pnpm run typecheck`
- 契約與文件:
  - `corepack pnpm run openapi:check`
  - `corepack pnpm run contract:test`
  - `corepack pnpm run docs:check`
- 煙霧測試:
  - `corepack pnpm run smoke:connector`
  - `corepack pnpm run smoke:scheduler:ntp`

## 6. NTP 功能安裝後設定

- 旗標: `FEATURE_VMM_NTP_TIME_SYNC`（預設 `false`）
- 預設上游 NTP:
  - `NTP_UPSTREAM_HOST=time.google.com`
  - `NTP_UPSTREAM_PORT=123`
- 同步間隔:
  - `NTP_SYNC_INTERVAL_MIN=1..9999`
- 本地 NTP server（選用）:
  - `NTP_SERVER_ENABLED=true|false`
  - `NTP_SERVER_PORT=123`

## 7. 回滾方案

- 立即回滾（建議）:
  - 將相關 feature flag 設為 `false` 後 redeploy。
- NTP 回滾:
  - `FEATURE_VMM_NTP_TIME_SYNC=false`
  - `NTP_SERVER_ENABLED=false`
- 若需完整回退:
  - 移除對應 `deploy/env/*.prod.env` 載入並 redeploy。

## 8. 安裝結論

- 本系統具備可重現安裝流程、可驗證檢查點、可回滾機制。
- 目前安裝交付符合「可運行、可觀測、可維運」要求。
