# EverNet VMM/VMS 本次更新摘要

- 更新日期: 2026-02-17
- 分支: `main`
- 主要提交:
  - `5245353` feat: finalize rollout security observability and dashboard UX enhancements
  - `5ae7e78` docs: update README and changelog for rollout, ops, and dashboard ux

## 1) 本次完成項目

- 灰度發佈框架:
  - 新增 `FEATURE_ROLLOUT_GRADIENT`，支援百分比與 scope（site/tenant/camera）抽樣。
- 事件去重與風暴抑制:
  - 新增 `FEATURE_VMS_EVENT_DEDUP`，針對健康/告警事件 dedup 與最小間隔抑制。
- 內部安全與審計:
  - 新增 `FEATURE_INTERNAL_AUTHZ`，對 `/internal/*` 與管理路徑加入簽名驗證與 rate limit。
- 回放與分片能力強化:
  - Playback fallback/cache 可調，並補齊慢查詢/快取相關指標。
  - connector/scheduler 支援 site-aware weighted sharding 與桶分佈觀測。
- MCP 自動化與提示模板:
  - 擴充 MCP 產物：`mcp/prompts.json`、`mcp/ops-diag.json`。
  - 新增 `prompts/development.json`。
- 運維工具:
  - 新增 `scripts/diag-collect.mjs`、`scripts/smoke-aggregate.mjs`。
- 監控面板:
  - 新增 Grafana dashboard：`config/grafana/dashboards/ntp-sharding-playback.json`。
- UI/UX:
  - 新增 Dashboard UX v2（`FEATURE_WEB_DASHBOARD_UX_V2`，預設 OFF）。
  - 新增 UI 版本觀測 metric 與 response header。

## 2) 新增/重點 Feature Flags（預設 OFF）

- `FEATURE_ROLLOUT_GRADIENT=false`
- `FEATURE_VMS_EVENT_DEDUP=false`
- `FEATURE_INTERNAL_AUTHZ=false`
- `FEATURE_WEB_DASHBOARD_UX_V2=false`
- 既有關聯旗標維持 OFF（如 playback/cache/sharding/jitter/blackframe 路徑）

## 3) 主要可觀測性（新增）

- `vmm_rollout_exposure_total`
- `vmm_event_dedup_total`
- `vmm_event_suppress_total`
- `vmm_internal_auth_fail_total`
- `vmm_internal_rate_limited_total`
- `vmm_dashboard_page_views_total{ui_version}`

## 4) 驗證結果

- 已通過:
  - `corepack pnpm run env:check`
  - `corepack pnpm run typecheck`
  - `corepack pnpm run lint`
  - `corepack pnpm run test`
  - `corepack pnpm run contract:test`
  - `corepack pnpm run openapi:check`
  - `corepack pnpm run mcp:update`
  - `corepack pnpm run docs:check`

## 5) 風險與回滾

- 風險:
  - 若開啟 `FEATURE_INTERNAL_AUTHZ=true`，內部呼叫必須附正確簽名，否則會 401。
- 快速回滾:
  - 將新旗標切回 `false` 後 redeploy。
- 代碼回滾:
  - `git revert <commit>`

## 6) 上線建議順序

1. 先維持全部新旗標 OFF 部署。
2. 啟用 `FEATURE_ROLLOUT_GRADIENT=true` 並設定低比例（如 5%）觀察 metrics。
3. 分批開啟 `FEATURE_VMS_EVENT_DEDUP`、`FEATURE_INTERNAL_AUTHZ`、`FEATURE_WEB_DASHBOARD_UX_V2`。
4. 穩定後再提高 rollout 百分比至全量。
