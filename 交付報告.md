# EverNet VMM/VMS 交付報告

- 報告日期: 2026-02-17
- 分支: `main`
- 最新提交: `898700c`

## 1. 交付目標與範圍

- VMS 健康監測能力擴充: `OK/DEGRADED/DOWN/BLACKFRAME`，並以狀態變更才發事件避免風暴。
- VMM 回放 fallback 能力與管理報表能力已串接至既有流程。
- Connector 廠牌擴充與探測能力整合（含 VIVOTEK、ONVIF、RTSP、Generic CGI、SAMPO 等）。
- 新增 Scheduler NTP 同步/本地 NTP server 控制（Feature Flag 預設 OFF）。
- CI / 契約 / smoke / deploy 檢查與文件補強完成。

## 2. 主要功能交付摘要

### 2.1 Connector / VMS

- 新增多供應商 probe 模組並接入輪詢流程，失敗路徑採 fail-soft（timeout/離線/格式異常不 crash）。
- 新增 provider 探測指標與 smoke 腳本，支援部署後快速檢查。
- 新增 deploy overlay: `deploy/env/connector-vss.prod.env`。

### 2.2 Scheduler / NTP

- 新增 `FEATURE_VMM_NTP_TIME_SYNC`（預設 OFF）。
- 支援上游 NTP（預設 `time.google.com:123`）與可調同步間隔（1~9999 分鐘）。
- 支援本地 UDP NTP server（可開關），供區網 IPC/NVR 同步。
- 支援手動時間模式與回復上游模式 API。
- 站點化 API:
  - `GET /api/v1/sites/{siteId}/time-sync/status`
  - `POST /api/v1/sites/{siteId}/time-sync/manual`
- 新增 deploy overlay: `deploy/env/scheduler.prod.env`。

### 2.3 測試與治理

- 新增 scheduler 契約檢查: `scripts/contract-check-scheduler.mjs`。
- `contract:test` 已納入 scheduler。
- Docker smoke workflow 已納入 connector + scheduler NTP smoke。
- deploy env 檢查已同時覆蓋 connector 與 scheduler，含 NTP 參數範圍檢查。

## 3. Feature Flags（預設 OFF）

- `FEATURE_VMS_HEALTH_MONITOR`
- `FEATURE_VMM_PLAYBACK_FALLBACK_SCAN`
- `FEATURE_VMM_MANAGEMENT_REPORTS`
- `FEATURE_VMS_POLLING_SHARDING`
- `FEATURE_VMS_VIVOTEK_CGI`
- `FEATURE_VMS_ONVIF_PROBE`
- `FEATURE_VMS_RTSP_PROBE`
- `FEATURE_VMS_ACTI_CGI`
- `FEATURE_VMS_AVTECH_CGI`
- `FEATURE_VMS_LILIN_CGI`
- `FEATURE_VMS_GEOVISION_CGI`
- `FEATURE_VMS_HISHARP_CGI`
- `FEATURE_VMS_UNIVIEW_CGI`
- `FEATURE_VMS_HIKVISION_CGI`
- `FEATURE_VMS_XM_CGI`
- `FEATURE_VMS_SAMPO_CGI`
- `FEATURE_VMM_NTP_TIME_SYNC`

## 4. Observability 交付

- Camera/Stream:
  - `vmm_camera_reconnects`
  - `vmm_camera_fps`
  - `vmm_camera_drop_frames`
  - `vmm_camera_last_frame_ts_ms`
- Provider:
  - `vmm_provider_probe_total`
- Playback fallback:
  - `vmm_playback_fallback_total`
  - `vmm_playback_scan_duration_ms`
  - `vmm_playback_slow_query_total`
- NTP:
  - `vmm_ntp_sync_total`
  - `vmm_ntp_offset_ms`
  - `vmm_ntp_last_sync_ts_ms`
  - `vmm_ntp_server_requests_total`

## 5. 驗證結果（最近一次）

- `corepack pnpm run lint`：通過
- `corepack pnpm run test`：通過
- `corepack pnpm run contract:test`：通過（reporting / orchestrator / scheduler）
- `corepack pnpm run openapi:check`：通過
- `corepack pnpm run deploy:env:check`：通過（connector + scheduler）
- `corepack pnpm run docs:check`：通過

## 6. 部署與回滾

- 部署檔:
  - `deploy/env/connector-vss.prod.env`
  - `deploy/env/scheduler.prod.env`
- 參考文件:
  - `deploy/README.md`
- 快速回滾:
  - 將對應 feature flag 設為 `false` 後 redeploy。
  - NTP 回滾: `FEATURE_VMM_NTP_TIME_SYNC=false`、`NTP_SERVER_ENABLED=false`。

## 7. 近期主要提交（節錄）

- `898700c` docs(deploy): add scheduler ntp rollout and rollback guide
- `55ae452` chore(ci): extend docker smoke with connector and scheduler ntp checks
- `87c2046` test(contract): add scheduler route contract check
- `8a27bbb` feat(scheduler): add site-scoped time sync routes and openapi contract
- `5fe4e19` chore(smoke): add scheduler ntp smoke check
- `19bcc83` chore(ci): validate scheduler deploy env in deploy env check
- `6b0a300` chore(deploy): add scheduler ntp production env overlay
- `4c1519a` feat(scheduler): add feature-flagged ntp sync and local ntp server controls
- `ae025e7` chore(smoke): add connector-vss health and metrics smoke check
- `987d956` chore(deploy): add connector-vss production env overlay
- `83516e1` feat(connector-vss): add multi-vendor probes and SAMPO/VIVOTEK smoke tooling

## 8. 交付結論

- 本次需求已形成可運行、可觀測、可回滾的交付狀態。
- 已補齊 CI 檢查與部署指引，支援後續正式環境導入與分階段開關啟用。
