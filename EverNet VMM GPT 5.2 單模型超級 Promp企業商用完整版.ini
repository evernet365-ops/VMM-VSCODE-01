EverNet VMM 全系統重構開發 — GPT 5.2 單模型超級 Prompt（企業商用完整版）
============================================================
【角色設定】

你是一個具備企業級系統架構經驗的首席架構師 + 資深後端工程師 + DevOps 工程師 + 資安顧問。

你必須根據以下規格，完整產出可直接投入商用的影像管理平台（VMM / VMS）。

============================================================
一、開發總目標
============================================================

請重新開發 EverNet VMM 系統，滿足以下條件：

• 最大容量：128 台 NVR
• 最大設備數：1024 台攝影機 / 裝置
• 多 Site 架構（嚴格隔離）
• 商用等級穩定性（不死機設計）
• 統一通知閘道（Notification Gateway）
• 可擴充 AI 推論架構
• Docker 容器化部署
• OpenAPI 規格完整
• 具備監控、Runbook、降載與熔斷機制

============================================================
二、強制輸出規則（不可違反）
============================================================

必須輸出完整 Repo Tree

每個檔案完整內容（不得省略、不得使用 ...）

所有模組邊界清楚，不可混責

所有通知必須走 notification-gateway

不可跨 Site 查詢資料

必須附：

docker-compose.yml

.env.example

gateway.json.example

OpenAPI YAML

seed SQL

smoke test 腳本

Runbook

============================================================
三、系統模組架構
============================================================

packages/

connector-vss
ai-orchestrator
ai-worker
notification-gateway
reporting-engine
scheduler
web-dashboard
shared


資料庫：PostgreSQL
快取：Redis（可選）
監控：Prometheus + Grafana
容器：Docker + docker-compose

============================================================
四、容量與輪詢設計
============================================================
輪詢策略

正常狀態：

3~5 分鐘

加入 ±60 秒 jitter 分散負載

suspect 狀態：

1 分鐘輪詢

critical 狀態：

即時通知

加速驗證機制

必須實作：

jitter 機制

suspect 狀態機

自動恢復邏輯

============================================================
五、真正商用級「不死機設計」
============================================================

必須實作：

所有外部 API：

timeout

retry

指數退避

所有外部呼叫不可同步阻塞

DB 寫入失敗不得 crash

Queue 滿載自動降載

熔斷條件：

連續 5 次 API 失敗

latency > 5 秒

降載模式

關閉 AI 推論

降低輪詢頻率

暫停非 critical 通知

必須有可手動開關環境變數：

ENABLE_AI=false
POLL_INTERVAL=300
NOTIFY_NON_CRITICAL=false

============================================================
六、Notification Gateway 設計
============================================================

所有上游服務禁止直接呼叫：

Teams

LINE

SMS

Email

只能呼叫：

POST /internal/notify

gateway.json 控制

每 Site 可設定：

enabled

channels

rateLimitPerSitePerMin

gchat mode

outbound webhook routes

Google Chat 支援

mode:

text

cards

cards 模式必須支援：

Summary card

Top 20 card

Links 分組卡

buttonsPerCard=6

自動切片

============================================================
七、AI 架構設計
============================================================
ai_event 表

id

site_id

camera_id

event_type

severity

score

ts_event

dedup_key

ai_artifact 表

id

event_id

type

storage_path

metadata_json

Orchestrator 職責

接收 worker 上報

寫入 DB

呼叫 notification-gateway

提供查詢 API

============================================================
八、報表與健康監測
============================================================

必須產出：

15m / 1h / 4h / 8h / 24h 異常清單

Top 20 斷線

Top 20 缺錄

累積斷線時間排序

依 Site 排序

依累積時間大小排序

============================================================
九、監控與指標
============================================================

Prometheus 指標命名：

vmm_camera_online_total
vmm_camera_offline_total
vmm_nvr_online_total
vmm_ai_events_total
vmm_notification_sent_total
vmm_notification_failed_total


Grafana 面板必須顯示：

Site 異常數

系統負載

通知成功率

AI 事件量

DB 連線數

API latency

============================================================
十、Runbook 必須包含
============================================================

故障排除流程

API timeout 模擬

DB 失效模擬

Webhook 失效模擬

熔斷演練腳本

降載開關操作說明

============================================================
十一、部署需求
============================================================

必須提供：

docker-compose.yml

Postgres service

migration script

seed data

smoke test

healthz endpoint

graceful shutdown

============================================================
十二、禁止事項
============================================================

不得跨 Site 查詢資料

不得讓 provider token 出現在上游服務

不得省略任何檔案內容

不得產出示意或假程式碼

不得產出不完整 Repo Tree

============================================================
最終目標
============================================================

產出：

✔ 可直接商用部署的完整 VMM 系統原始碼
✔ 完整文件
✔ OpenAPI 規格
✔ Runbook
✔ 監控與容量設計